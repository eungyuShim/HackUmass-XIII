<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<title>Grade Planner — Dashboard</title>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
  <link rel="stylesheet" href="../css/global.css"/>
  <link rel="stylesheet" href="../css/dashboard.css"/>
</head>
<body>
<div class="layout">
  <!-- 사이드바 -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <h1>Grade<br>Planner</h1>
      <p>Academic planning made easy</p>
    </div>
    <nav>
      <ul class="nav-list">
        <li class="nav-item">
          <a href="course.html" class="nav-link">
            ← Back to Courses
          </a>
        </li>
        <li class="nav-item">
          <a href="#" class="nav-link active">
            Dashboard
          </a>
        </li>
      </ul>
    </nav>
  </aside>

  <!-- 메인 콘텐츠 -->
  <div class="main-content">
    <header class="header">
      <div>
        <div style="font-size:13px;color:var(--txt-muted);margin-bottom:4px">Current Course</div>
        <h2 id="course">Course Name</h2>
      </div>
      <!-- Updated header button to open setup modal -->
      <button class="upload-btn" onclick="openSetupModal()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M17 8l-5-5-5 5M12 3v12"/>
        </svg>
        Course Setup
      </button>
    </header>

    <div class="wrap">
      <!-- New two-step setup modal (Syllabus Upload + AI Analysis) -->
      <div id="setupModal" class="modal-overlay" style="display:none">
        <div class="modal-content setup-modal">
          <!-- Step 1: Syllabus Upload -->
          <div id="step1" class="setup-step">
            <h3 style="margin-bottom:16px;font-size:24px;color:var(--txt)">Step 1: Upload Your Syllabus</h3>
            <p style="color:var(--txt-muted);line-height:1.7;margin-bottom:24px">
              Upload your course syllabus (PDF) and our AI will extract important information including grading weights, drop policies, exam counts, extra credit opportunities, and assignment details.
            </p>
            
            <div class="upload-area" onclick="document.getElementById('syllabusFileUpload').click()">
              <svg class="upload-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                <polyline points="14 2 14 8 20 8"/>
                <line x1="12" y1="18" x2="12" y2="12"/>
                <line x1="9" y1="15" x2="12" y2="12"/>
                <line x1="15" y1="15" x2="12" y2="12"/>
              </svg>
              <div class="upload-text">Click to upload syllabus</div>
              <div class="upload-hint">PDF, DOC, DOCX files supported</div>
            </div>
            <input type="file" id="syllabusFileUpload" accept=".pdf,.doc,.docx" style="display:none">
            <div id="uploadStatus" style="margin-top:16px;color:var(--txt-muted);font-size:14px"></div>
            
            <div class="row" style="justify-content:flex-end;margin-top:24px">
              <button class="btn btn--ghost" onclick="closeSetupModal()">Cancel</button>
              <button class="btn btn--ghost" onclick="skipToAnalysis()">Skip Upload</button>
              <button id="proceedBtn" class="btn btn--primary" onclick="proceedToAnalysis()" disabled>Continue to Analysis</button>
            </div>
          </div>

          <!-- Step 2: AI Analysis Configuration -->
          <div id="step2" class="setup-step" style="display:none">
            <h3 style="margin-bottom:16px;font-size:24px;color:var(--txt)">Step 2: Configure Grade Weights</h3>
            <p style="color:var(--txt-muted);line-height:1.7;margin-bottom:24px">
              Review the extracted information from your syllabus. You can modify any values below before confirming and proceeding to your dashboard.
            </p>

            <!-- Replaced fixed weight inputs with dynamic category management -->
            <div class="analysis-card">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
                <h4 style="margin:0">Grade Categories</h4>
                <button class="btn btn-small btn--secondary" onclick="addSetupCategory()">+ Add</button>
              </div>
              <div id="setupCategoriesList" style="display:flex;flex-direction:column;gap:12px"></div>
              <div style="margin-top:12px;padding:8px;background:var(--bg-gray);border-radius:6px;font-size:13px">
                <b>Total:</b> <span id="setupTotalWeight">0</span>% 
                <span id="setupWeightWarning" style="color:#dc2626;display:none">⚠️ Must equal 100%</span>
              </div>
            </div>

            <div class="row" style="justify-content:flex-end;margin-top:32px">
              <button class="btn btn--ghost" onclick="backToUpload()">← Back</button>
              <button class="btn btn--primary" onclick="confirmSetup()">Confirm & Apply Settings</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Syllabus upload modal (shown on first visit) -->
      <div id="uploadModal" class="modal-overlay" style="display:none">
        <div class="modal-content">
          <h3 style="margin-bottom:24px;font-size:24px;color:var(--txt)">Welcome! Upload Your Syllabus</h3>
          <div class="upload-area" onclick="document.getElementById('syllabusFile').click()">
            <svg class="upload-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
              <polyline points="14 2 14 8 20 8"/>
              <line x1="12" y1="18" x2="12" y2="12"/>
              <line x1="9" y1="15" x2="12" y2="12"/>
              <line x1="15" y1="15" x2="12" y2="12"/>
            </svg>
            <div class="upload-text">Click to upload syllabus</div>
            <div class="upload-hint">PDF, DOC, DOCX files supported</div>
          </div>
          <button class="btn btn--ghost" onclick="closeUploadModal()" style="width:100%;margin-top:16px">Skip for now</button>
        </div>
      </div>

      <!-- Improved progress bar -->
      <div class="card">
        <h3>Grade Range Projection</h3>
        <div class="progress-container">
          <div class="progress-label">
            <span class="progress-label-text">Maximum Possible Grade</span>
            <span class="progress-label-value" id="maxVal">0%</span>
          </div>
          <div class="progress-bar-bg">
            <div class="progress-bar-fill" id="maxFill" style="width:0%"></div>
          </div>
        </div>
      </div>

      <!-- 카테고리 관리 섹션 -->
      <div class="card">
        <div class="row space-between" style="margin-bottom:24px">
          <h3 style="margin:0">Grade Categories</h3>
          <button class="btn btn--secondary btn-small" onclick="addCategory()">+ Add Category</button>
        </div>
        
        <div id="categoriesList" class="category-grid"></div>
        
        <div style="margin-top:16px;padding:12px;background:var(--bg-gray);border-radius:8px;font-size:14px;color:var(--txt-muted)">
          <b>Total Weight:</b> <span id="totalWeight">0</span>% 
          <span id="weightWarning" style="color:#dc2626;display:none">⚠️ Must equal 100%</span>
        </div>
      </div>

      <!-- Target Grade 설정 섹션 -->
      <div class="card">
        <h3>Target Grade Settings</h3>
        <div class="row">
          <div class="input-group" style="flex:1">
            <label class="input-label">Target Grade</label>
            <input id="goal" class="input" type="text" placeholder="A-, B+, 90">
          </div>
          <button id="calc" class="btn btn--primary" style="align-self:end">Calculate Required Scores</button>
        </div>
      </div>

      <!-- Required Scores 결과 -->
      <div class="card">
        <h3>Required Scores (Strategy)</h3>
        <ul id="needs" style="margin:0;padding-left:20px;line-height:2;color:var(--txt)">
          <li>Enter target grade and calculate to see required scores...</li>
        </ul>
      </div>

      <!-- Current Grade Summary -->
      <div class="card">
        <details>
          <summary style="cursor:pointer;font-weight:600;padding:8px 0">View Current Grade Summary</summary>
          <div style="margin-top:24px;overflow-x:auto">
            <table style="width:100%;border-collapse:collapse">
              <thead>
                <tr style="border-bottom:2px solid var(--border-light)">
                  <th style="text-align:left;padding:12px;font-weight:600">Category</th>
                  <th style="text-align:left;padding:12px;font-weight:600">Current Average</th>
                  <th style="text-align:left;padding:12px;font-weight:600">Weight (%)</th>
                  <th style="text-align:left;padding:12px;font-weight:600">Status</th>
                </tr>
              </thead>
              <tbody id="sumBody"></tbody>
            </table>
          </div>
        </details>
      </div>
    </div>
  </div>
</div>

<script>
  
  const courseName=sessionStorage.getItem('current_course_name')||'Selected Course';
  document.getElementById('course').textContent=courseName;

  let categories = [
    {id: 1, name: 'Midterm Exam', weight: 20, locked: true, items: [{name: 'Midterm 1', score: 85, locked: true}]},
    {id: 2, name: 'Final Exam', weight: 30, locked: true, items: [{name: 'Final', score: null, locked: false}]},
    {id: 3, name: 'Assignments', weight: 25, locked: false, items: [
      {name: 'Assignment 1', score: 90, locked: true},
      {name: 'Assignment 2', score: 88, locked: true},
      {name: 'Assignment 3', score: null, locked: false},
      {name: 'Assignment 4', score: null, locked: false}
    ]},
    {id: 4, name: 'Quizzes', weight: 25, locked: false, items: [
      {name: 'Quiz 1', score: 95, locked: true},
      {name: 'Quiz 2', score: null, locked: false}
    ]}
  ];

  let nextCategoryId = 5;

  function renderCategories() {
    const container = document.getElementById('categoriesList');
    container.innerHTML = '';
    
    categories.forEach(cat => {
      const catDiv = document.createElement('div');
      catDiv.className = 'category-item' + (cat.locked ? ' locked' : '');
      catDiv.innerHTML = `
        <div class="category-info">
          <div class="category-name">${cat.name} ${cat.locked ? '<span class="badge badge-locked">Fixed</span>' : '<span class="badge badge-editable">Editable</span>'}</div>
          <div class="category-weight">Weight: ${cat.weight}%</div>
        </div>
        <div class="category-actions">
          <button class="btn btn-small btn--ghost" onclick="editCategory(${cat.id})">Edit</button>
          <button class="btn btn-small btn--ghost" onclick="toggleCategoryDetails(${cat.id})">Items (${cat.items.length})</button>
          ${!cat.locked ? `<button class="btn btn-small btn--danger" onclick="deleteCategory(${cat.id})">Delete</button>` : ''}
        </div>
      `;
      container.appendChild(catDiv);
      
      const itemsDiv = document.createElement('div');
      itemsDiv.id = `items-${cat.id}`;
      itemsDiv.className = 'item-list';
      itemsDiv.style.display = 'none';
      
      cat.items.forEach((item, idx) => {
        const itemDiv = document.createElement('div');
        itemDiv.className = 'item' + (item.locked ? ' locked' : '');
        itemDiv.innerHTML = `
          <div class="item-name">${item.name}</div>
          <div class="item-score ${item.locked ? 'locked' : ''}">${item.score !== null ? item.score + '%' : 'Not graded'}</div>
          <div>
            ${!item.locked ? `<button class="btn btn-small btn--ghost" onclick="editItem(${cat.id}, ${idx})">Edit</button>` : ''}
          </div>
        `;
        itemsDiv.appendChild(itemDiv);
      });
      
      container.appendChild(itemsDiv);
    });
    
    updateTotalWeight();
  }

  function updateTotalWeight() {
    const total = categories.reduce((sum, cat) => sum + cat.weight, 0);
    document.getElementById('totalWeight').textContent = total;
    const warning = document.getElementById('weightWarning');
    if (total !== 100) {
      warning.style.display = 'inline';
    } else {
      warning.style.display = 'none';
    }
  }

  function toggleCategoryDetails(id) {
    const itemsDiv = document.getElementById(`items-${id}`);
    itemsDiv.style.display = itemsDiv.style.display === 'none' ? 'block' : 'none';
  }

  function addCategory() {
    const name = prompt('Category name:');
    if (!name) return;
    const weight = parseInt(prompt('Weight (%):'));
    if (isNaN(weight)) return;
    
    categories.push({
      id: nextCategoryId++,
      name: name,
      weight: weight,
      locked: false,
      items: []
    });
    renderCategories();
  }

  function editCategory(id) {
    const cat = categories.find(c => c.id === id);
    if (!cat) return;
    
    const newName = prompt('Category name:', cat.name);
    if (newName) cat.name = newName;
    
    const newWeight = parseInt(prompt('Weight (%):', cat.weight));
    if (!isNaN(newWeight)) cat.weight = newWeight;
    
    renderCategories();
  }

  function deleteCategory(id) {
    if (!confirm('Delete this category?')) return;
    categories = categories.filter(c => c.id !== id);
    renderCategories();
  }

  function editItem(catId, itemIdx) {
    const cat = categories.find(c => c.id === catId);
    if (!cat) return;
    const item = cat.items[itemIdx];
    if (!item) return;
    
    const newName = prompt('Item name:', item.name);
    if (newName) item.name = newName;
    
    const newScore = prompt('Score (leave empty if not graded):', item.score || '');
    if (newScore === '') {
      item.score = null;
    } else {
      const score = parseFloat(newScore);
      if (!isNaN(score)) item.score = score;
    }
    
    renderCategories();
  }

  renderCategories();

  const current = {
    examsAvg: 82,
    quizzesAvg: 91,
    hwAvg: 88,
    attendance: 100,
    earnedPct: 38.5,
    remainingWeight: 0.61
  };

  const minPct = Math.max(0, Math.min(100, current.earnedPct));
  const maxPct = Math.max(minPct, Math.min(100, minPct + current.remainingWeight*100));
  document.getElementById('maxFill').style.width=maxPct+'%';
  document.getElementById('maxVal').textContent=maxPct.toFixed(1)+'%';

  function parseGoal(g){
    const map={'A+':97,'A':93,'A-':90,'B+':87,'B':83,'B-':80,'C+':77,'C':73,'C-':70};
    if(!g) return null;
    const up=g.trim().toUpperCase();
    if(map[up]!=null) return map[up];
    const n=Number(up);
    return isFinite(n)?n:null;
  }

  function computeNeeds(target){
    const remW = current.remainingWeight;
    if(remW<=0) return {neededAvg:Infinity, rows:[]};
    const C = minPct;
    const neededAvg = Math.max(0,(target-C)/remW);

    const rows=[];
    rows.push(`<b>Overall needed average:</b> ${neededAvg.toFixed(1)}% across remaining work`);
    rows.push(`Exams: Fixed at current ${current.examsAvg}%`);
    const adjQz = Math.min(100, Math.max(0, neededAvg + (90 - current.quizzesAvg)));
    const adjHw = Math.min(100, Math.max(0, neededAvg + (90 - current.hwAvg)));
    rows.push(`Quizzes: Average ~${adjQz.toFixed(1)}% on remaining quizzes`);
    rows.push(`Assignments: Average ~${adjHw.toFixed(1)}% on remaining assignments`);
    rows.push(`Attendance: ${current.attendance}% (adjustable)`);

    return {neededAvg, rows};
  }

  const sumBody=document.getElementById('sumBody');
  categories.forEach(cat=>{
    const avg = cat.items.reduce((sum, item) => sum + (item.score || 0), 0) / cat.items.length || 0;
    const status = cat.locked ? '<span class="badge badge-locked">Fixed</span>' : '<span class="badge badge-editable">Editable</span>';
    const tr=document.createElement('tr');
    tr.style.borderBottom = '1px solid var(--border-light)';
    tr.innerHTML=`<td style="padding:12px">${cat.name}</td><td style="padding:12px">${avg.toFixed(1)}%</td><td style="padding:12px">${cat.weight}%</td><td style="padding:12px">${status}</td>`;
    sumBody.appendChild(tr);
  });

  document.getElementById('calc').onclick=()=>{
    const G=parseGoal(document.getElementById('goal').value);
    if(G==null){
      alert('Please enter a target grade (e.g., A-, B+, or 90)');
      return;
    }
    const {neededAvg, rows}=computeNeeds(G);
    document.getElementById('needs').innerHTML = rows.map(r=>`<li>${r}</li>`).join('');
  };

  // Setup modal management
  function openSetupModal() {
    document.getElementById('setupModal').style.display = 'flex';
    document.getElementById('step1').style.display = 'block';
    document.getElementById('step2').style.display = 'none';
  }

  function closeSetupModal() {
    document.getElementById('setupModal').style.display = 'none';
  }

  // File upload handler
  document.getElementById('syllabusFileUpload').addEventListener('change', function(e) {
    if (e.target.files.length > 0) {
      const fileName = e.target.files[0].name;
      document.getElementById('uploadStatus').textContent = '✓ File selected: ' + fileName;
      document.getElementById('uploadStatus').style.color = 'var(--success)';
      document.getElementById('proceedBtn').disabled = false;
    }
  });

  function skipToAnalysis() {
    document.getElementById('uploadStatus').textContent = '';
    proceedToAnalysis();
  }

  function proceedToAnalysis() {
    document.getElementById('step1').style.display = 'none';
    document.getElementById('step2').style.display = 'block';
    renderSetupCategories();
  }

  function backToUpload() {
    document.getElementById('step1').style.display = 'block';
    document.getElementById('step2').style.display = 'none';
  }

  function confirmSetup() {
    const total = setupCategories.reduce((sum, cat) => sum + cat.weight, 0);
    
    if (total !== 100) {
      alert('Grade weights must total 100%');
      return;
    }
    
    sessionStorage.setItem('course_setup', JSON.stringify(setupCategories));
    closeSetupModal();
    alert('Settings applied successfully!');
    
    loadCategoriesFromSetup();
  }

  function loadCategoriesFromSetup() {
    const setupData = sessionStorage.getItem('course_setup');
    if (!setupData) return;
    
    const setup = JSON.parse(setupData);
    categories = [];
    let id = 1;
    
    setup.forEach(cat => {
      const items = [];
      for (let i = 1; i <= cat.count; i++) {
        items.push({name: `${cat.name} ${i}`, score: null, locked: false});
      }
      categories.push({
        id: id++,
        name: cat.name,
        weight: cat.weight,
        locked: false,
        items: items
      });
    });
    
    nextCategoryId = id;
    renderCategories();
  }

  let setupCategories = [
    {id: 1, name: 'Midterm Exam', weight: 20, count: 1},
    {id: 2, name: 'Final Exam', weight: 30, count: 1},
    {id: 3, name: 'Assignments', weight: 25, count: 5},
    {id: 4, name: 'Quizzes', weight: 25, count: 3}
  ];
  let nextSetupCategoryId = 5;

  function renderSetupCategories() {
    const container = document.getElementById('setupCategoriesList');
    container.innerHTML = '';
    
    setupCategories.forEach(cat => {
      const catDiv = document.createElement('div');
      catDiv.style.cssText = 'background:var(--bg-gray);border:1px solid var(--border-light);border-radius:8px;padding:16px;display:flex;justify-content:space-between;align-items:center';
      catDiv.innerHTML = `
        <div style="flex:1">
          <input type="text" value="${cat.name}" 
                 onchange="updateSetupCategoryName(${cat.id}, this.value)"
                 style="border:none;background:transparent;font-weight:600;font-size:15px;color:var(--txt);width:200px"
                 placeholder="Category name">
          <div style="font-size:13px;color:var(--txt-muted);margin-top:4px">
            <input type="number" value="${cat.weight}" min="0" max="100"
                   onchange="updateSetupCategoryWeight(${cat.id}, this.value)"
                   style="width:60px;border:1px solid var(--border);border-radius:4px;padding:4px;font-size:13px">% 
            | 
            <input type="number" value="${cat.count}" min="1" 
                   onchange="updateSetupCategoryCount(${cat.id}, this.value)"
                   style="width:50px;border:1px solid var(--border);border-radius:4px;padding:4px;font-size:13px"> items
          </div>
        </div>
        <button class="btn btn-small btn--danger" onclick="deleteSetupCategory(${cat.id})">Delete</button>
      `;
      container.appendChild(catDiv);
    });
    
    updateSetupTotalWeight();
  }

  function updateSetupTotalWeight() {
    const total = setupCategories.reduce((sum, cat) => sum + cat.weight, 0);
    document.getElementById('setupTotalWeight').textContent = total;
    const warning = document.getElementById('setupWeightWarning');
    if (total !== 100) {
      warning.style.display = 'inline';
    } else {
      warning.style.display = 'none';
    }
  }

  function addSetupCategory() {
    setupCategories.push({
      id: nextSetupCategoryId++,
      name: 'New Category',
      weight: 0,
      count: 1
    });
    renderSetupCategories();
  }

  function updateSetupCategoryName(id, newName) {
    const cat = setupCategories.find(c => c.id === id);
    if (cat) {
      cat.name = newName;
      renderSetupCategories();
    }
  }

  function updateSetupCategoryWeight(id, newWeight) {
    const cat = setupCategories.find(c => c.id === id);
    if (cat) {
      cat.weight = parseInt(newWeight) || 0;
      renderSetupCategories();
    }
  }

  function updateSetupCategoryCount(id, newCount) {
    const cat = setupCategories.find(c => c.id === id);
    if (cat) {
      cat.count = parseInt(newCount) || 1;
      renderSetupCategories();
    }
  }

  function deleteSetupCategory(id) {
    if (!confirm('Delete this category?')) return;
    setupCategories = setupCategories.filter(c => c.id !== id);
    renderSetupCategories();
  }

  function proceedToAnalysis() {
    document.getElementById('step1').style.display = 'none';
    document.getElementById('step2').style.display = 'block';
    renderSetupCategories();
  }

  // Show setup modal on first visit
  const hasVisited = sessionStorage.getItem('dashboard_visited');
  if (!hasVisited) {
    openSetupModal();
    sessionStorage.setItem('dashboard_visited', 'true');
  }
</script>
</body>
</html>
